#include <iostream>
#include <concepts>
#include <vector>

// ============================================================================
// ДЕМОНСТРАЦИЯ ПОЛЬЗОВАТЕЛЬСКИХ КОНЦЕПЦИЙ C++20
// ============================================================================

// ============================================================================
// СОЗДАНИЕ ПОЛЬЗОВАТЕЛЬСКОЙ КОНЦЕПЦИИ
// ============================================================================

// Пользовательская концепция для типов, которые можно выводить в поток
// Проверяет, что тип T поддерживает операцию вывода в std::ostream
template <typename T>
concept OutputStreamable = requires(std::ostream& output_stream, T data){
	output_stream << data;
};

// ============================================================================
// ФУНКЦИЯ-ШАБЛОН С ИСПОЛЬЗОВАНИЕМ КОНЦЕПЦИИ
// ============================================================================

// Оператор вывода для std::vector с ограничением на тип элементов
// Активируется только если тип T поддерживает вывод в поток
template <OutputStreamable T>
// template <class T>
// requires OutputStreamable<T>
std::ostream& operator<<(std::ostream& output_stream, const std::vector<T>& vector_data){
   	output_stream << " [ ";
  	for(auto element : vector_data){
      	output_stream << element << " ";
   	 }
   	output_stream << "]";
   	return output_stream;
}

// ============================================================================
// ТЕСТОВЫЙ КЛАСС ДЛЯ ДЕМОНСТРАЦИИ КОНЦЕПЦИИ
// ============================================================================

// Структура точки с оператором вывода
struct Point{
	double x_coordinate;  // Координата X
	double y_coordinate;  // Координата Y

	// Конструктор по умолчанию
	Point() = default;
	
	// Конструктор с параметрами
	Point(double x, double y) : x_coordinate(x), y_coordinate(y) {}

	// Дружественная функция для вывода точки в поток
	friend std::ostream& operator<<(std::ostream& output_stream, const Point point){
		output_stream << "Point [ x : " << point.x_coordinate 
		              << ", y : " << point.y_coordinate << "]";
		return output_stream;
	}
};

// ============================================================================
// ОСНОВНАЯ ФУНКЦИЯ - ДЕМОНСТРАЦИЯ ПОЛЬЗОВАТЕЛЬСКИХ КОНЦЕПЦИЙ
// ============================================================================

int main(){
    std::cout << "=== ДЕМОНСТРАЦИЯ ПОЛЬЗОВАТЕЛЬСКИХ КОНЦЕПЦИЙ C++20 ===" << std::endl << std::endl;
    
    // ========================================================================
    // ДЕМОНСТРАЦИЯ 1: ВЫВОД ВЕКТОРА ЦЕЛЫХ ЧИСЕЛ
    // ========================================================================
    std::cout << "1. Вывод вектора целых чисел:" << std::endl;
    std::vector<int> integer_numbers {1, 2, 3, 4, 5};
    std::cout << "   numbers : " << integer_numbers << std::endl << std::endl;
    
    // ========================================================================
    // ДЕМОНСТРАЦИЯ 2: ВЫВОД ВЕКТОРА ТОЧЕК
    // ========================================================================
    std::cout << "2. Вывод вектора точек:" << std::endl;
    std::vector<Point> point_collection {{10, 20}, {59, 45}};
    std::cout << "   points : " << point_collection << std::endl << std::endl;
    
    // ========================================================================
    // ДЕМОНСТРАЦИЯ 3: ОБЪЯСНЕНИЕ ПРИНЦИПА РАБОТЫ
    // ========================================================================
    std::cout << "3. Принцип работы пользовательских концепций:" << std::endl;
    std::cout << "   - concept OutputStreamable - пользовательская концепция" << std::endl;
    std::cout << "   - requires(expression) - проверка возможности операции" << std::endl;
    std::cout << "   - output_stream << data - проверка вывода в поток" << std::endl;
    std::cout << "   - template <OutputStreamable T> - использование концепции" << std::endl;
    std::cout << "   - Компилятор проверяет ограничения на этапе компиляции" << std::endl << std::endl;
    
    // ========================================================================
    // ДЕМОНСТРАЦИЯ 4: ПРЕИМУЩЕСТВА КОНЦЕПЦИЙ
    // ========================================================================
    std::cout << "4. Преимущества пользовательских концепций:" << std::endl;
    std::cout << "   - Читаемость кода" << std::endl;
    std::cout << "   - Лучшие сообщения об ошибках" << std::endl;
    std::cout << "   - Замена сложных SFINAE конструкций" << std::endl;
    std::cout << "   - Более понятные ограничения типов" << std::endl;
    std::cout << "   - Современный подход к метапрограммированию" << std::endl;
   
    return 0;
}